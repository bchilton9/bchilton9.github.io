<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gadget Guide Editor</title>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
  <style>
    /* ... (previous styles remain) ... */
    .editor-tabs { /* ... */ } /* same */
    /* New image tab styles */
    .image-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 0.5rem;
    }
    .image-grid img {
      width: 100%;
      border-radius: 4px;
      cursor: pointer;
      border: 2px solid transparent;
    }
    .image-grid img.selected {
      border-color: #0af;
    }
  </style>
</head>
<body>
  <div id="header-placeholder"></div>

  <main>
    <h2>üõ†Ô∏è Article Editor</h2>
    <select id="articleLoader">...</select>

    <div class="editor-tabs">
      <button class="tab-btn active" data-tab="details">Details</button>
      <button class="tab-btn" data-tab="wysiwyg">Editor</button>
      <button class="tab-btn" data-tab="markdown">Markdown</button>
      <button class="tab-btn" data-tab="images">Images</button>
      <button class="tab-btn" data-tab="export">Export</button>
    </div>

    <div id="tab-details" class="tab-content active">‚Ä¶</div>
    <div id="tab-wysiwyg" class="tab-content"><div id="editorContainer"></div></div>
    <div id="tab-markdown" class="tab-content"><textarea id="markdownEditor"></textarea></div>

    <div id="tab-images" class="tab-content">
      <h3>Select an image to insert</h3>
      <div id="imageGrid" class="image-grid">Loading images‚Ä¶</div>
    </div>

    <div id="tab-export" class="tab-content">‚Ä¶</div>
  </main>

  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    // Load header and init hamburger menu
    fetch("header.html").then(res => res.text()).then(html => {
      document.getElementById("header-placeholder").innerHTML = html;
      const menuToggle = document.getElementById("menuToggle"), nav = document.getElementById("navLinks");
      menuToggle.addEventListener("click", () => nav.classList.toggle("open"));
      document.addEventListener("click", e => {
        if (!menuToggle.contains(e.target) && !nav.contains(e.target)) nav.classList.remove("open");
      });
    });

    // Tabs
    document.querySelectorAll(".tab-btn").forEach(btn => btn.addEventListener("click", () => {
      document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const id = "tab-" + btn.dataset.tab;
      document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }));

    // Quill editor setup
    const quill = new Quill('#editorContainer', { theme: 'snow' });
    quill.on('text-change', () => {
      const html = quill.root.innerHTML;
      document.getElementById("markdownEditor").value = htmlToMarkdown(html);
    });
    document.getElementById("markdownEditor").addEventListener("input", e => {
      const html = marked.parse(e.target.value);
      quill.root.innerHTML = html;
    });

    function htmlToMarkdown(html) {
      return html
        .replace(/<img[^>]*src="([^"]+)"[^>]*>/g, '![]($1)')
        .replace(/<h1>(.*?)<\/h1>/g, '# $1\n\n')
        .replace(/<h2>(.*?)<\/h2>/g, '## $1\n\n')
        .replace(/<strong>(.*?)<\/strong>/g, '**$1**')
        .replace(/<em>(.*?)<\/em>/g, '*$1*')
        .replace(/<p>(.*?)<\/p>/g, '$1\n\n')
        .replace(/<br\s*\/?>/g, '\n')
        .replace(/<\/?[^>]+(>|$)/g, "");
    }

    // Load JSON and images
    let allArticles = [];
    fetch("articles.json").then(r=>r.json()).then(data => {
      allArticles = data;
      populateLoaderDropdown();
      updateJSON();
    });

    const mdInput = document.getElementById("markdownEditor");
    document.getElementById("downloadMd").onclick = copyToFile(mdInput.value, "md");
    document.getElementById("copyMd").onclick = () => { navigator.clipboard.writeText(mdInput.value); alert("MD copied"); };
    document.getElementById("copyJson").onclick = () => {
      navigator.clipboard.writeText(JSON.stringify(buildJSON(), null,2));
      alert("JSON copied");
    };
    document.getElementById("downloadJson").onclick = copyToFile(JSON.stringify(buildJSON(), null,2), "json");

    async function loadImages(){
      try {
        const res = await fetch("images/");
        const parser = new DOMParser();
        const doc = parser.parseFromString(await res.text(), 'text/html');
        const images = Array.from(doc.querySelectorAll('a')).filter(a=>a.href.match(/\.(jpe?g|png|gif)$/));
        const grid = document.getElementById("imageGrid");
        grid.innerHTML = '';
        images.forEach(a=>{
          const img = document.createElement("img");
          img.src = `images/${a.textContent}`;
          img.alt = a.textContent;
          img.onclick = ()=>{
            document.querySelectorAll("#imageGrid img").forEach(i=>i.classList.remove("selected"));
            img.classList.add("selected");
            quill.focus();
            const range = quill.getSelection(true);
            quill.insertEmbed(range.index, 'image', img.src);
          };
          grid.appendChild(img);
        });
      } catch (e){
        document.getElementById("imageGrid").textContent = "Could not load images.";
      }
    }
    loadImages();

    // Helpers
    function buildJSON(){
      return {
        id: document.getElementById("id").value.trim(),
        title: document.getElementById("title").value.trim(),
        summary: document.getElementById("summary").value.trim(),
        image: document.getElementById("image").value.trim(),
        categories: document.getElementById("categories").value.split(",").map(c=>c.trim()).filter(Boolean)
      };
    }

    function populateLoaderDropdown(){
      const sel = document.getElementById("articleLoader");
      allArticles.forEach(a=>{
        const o = document.createElement("option");
        o.value = a.id; o.textContent = a.title;
        sel.appendChild(o);
      });
    }
    document.getElementById("articleLoader").onchange = async e => {
      if (!e.target.value) return clearAll();
      const art = allArticles.find(a=>a.id===e.target.value);
      document.getElementById("id").value = art.id;
      document.getElementById("title").value = art.title;
      document.getElementById("summary").value = art.summary;
      document.getElementById("image").value = art.image;
      document.getElementById("categories").value = art.categories.join(", ");
      const md = await (await fetch(`articles/${art.id}.md`)).text();
      mdInput.value = md;
      quill.root.innerHTML = marked.parse(md);
    };

    function clearAll(){
      ["id","title","summary","image","categories"].forEach(i=>document.getElementById(i).value="");
      mdInput.value = "";
      quill.setText("");
    }

    function updateJSON(){
      document.getElementById("articleListDisplay").textContent = JSON.stringify(allArticles, null,2);
    }

    function copyToFile(content, ext){
      return () => {
        const blob = new Blob([content], {type: ext==="md"? "text/markdown":"application/json"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = ext==="md" ? "article.md": "articles.json";
        a.click();
      };
    }
  </script>
</body>
</html>
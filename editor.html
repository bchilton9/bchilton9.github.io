<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gadget Guide Editor</title>

  <link rel="stylesheet" href="styles.css" />
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet" />

  <style>
    /* Reset and base */
    body {
      font-family: system-ui, sans-serif;
      background: #111;
      color: #eee;
      margin: 0;
      padding: 1rem;
      box-sizing: border-box;
      min-height: 100vh;
      max-width: 100vw;
      overflow-x: hidden;
    }

    #header-placeholder {
      margin-bottom: 1rem;
      padding: 0; /* Removed extra padding */
    }

    h1 {
      margin-bottom: 1rem;
      font-weight: 700;
      font-size: 1.8rem;
      color: #0af;
    }

    label {
      display: block;
      margin: 1rem 0 0.3rem 0;
      font-weight: 600;
      color: #aaf;
    }

    input[type=text], select {
      width: 100%;
      max-width: 600px;
      padding: 0.5rem 0.75rem;
      font-size: 1rem;
      border-radius: 5px;
      border: 1px solid #444;
      background: #222;
      color: #eee;
      transition: border-color 0.2s ease;
    }
    input[type=text]:focus, select:focus {
      outline: none;
      border-color: #0af;
      background: #1a1a3d;
    }

    #categoryCheckboxes label {
      cursor: pointer;
      display: inline-block;
      margin-right: 1.25rem;
      font-weight: normal;
      user-select: none;
      color: #ccddee;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }
    #categoryCheckboxes input[type=checkbox] {
      margin-right: 0.4rem;
      cursor: pointer;
      transform: scale(1.1);
      vertical-align: middle;
    }

    #newCategory {
      max-width: 300px;
      margin-top: 0.5rem;
      margin-right: 0.5rem;
      display: inline-block;
    }

    #addCategoryBtn {
      background: #0af;
      border: none;
      color: white;
      font-weight: 700;
      padding: 0.45rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    #addCategoryBtn:hover {
      background: #09e;
    }

    #quillEditor {
      height: 320px;
      max-width: 100%;
      border-radius: 6px;
      margin-top: 0.5rem;
      background: white;
      color: black;
      box-shadow: 0 0 8px rgba(10, 170, 255, 0.3);
    }

    pre#markdownContent,
    pre#jsonOutput {
      background: #222;
      color: #eee;
      padding: 1rem 1rem 1.5rem 1rem;
      border-radius: 8px;
      white-space: pre-wrap;
      max-height: 320px;
      overflow-y: auto;
      font-family: 'Source Code Pro', monospace, monospace;
      font-size: 0.9rem;
      margin-top: 1rem;
      position: relative;
      user-select: text;
      box-shadow: 0 0 6px rgba(0,0,0,0.5);
    }

    /* Copy buttons positioned inside pre tags top-right corner */
    pre#markdownContent > button.copy-corner-btn,
    pre#jsonOutput > button.copy-corner-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #0af;
      border: none;
      color: white;
      padding: 0.3rem 0.6rem;
      border-radius: 5px;
      font-size: 0.8rem;
      cursor: pointer;
      font-weight: 700;
      box-shadow: 0 0 6px rgba(10,170,255,0.7);
      user-select: none;
      transition: background-color 0.2s ease;
      z-index: 20;
    }
    pre#markdownContent > button.copy-corner-btn:hover,
    pre#jsonOutput > button.copy-corner-btn:hover {
      background: #09e;
    }

    button#downloadMd,
    button#downloadJson {
      background: #0af;
      border: none;
      padding: 0.7rem 1.3rem;
      border-radius: 6px;
      color: white;
      font-weight: 700;
      cursor: pointer;
      margin-top: 1.25rem;
      margin-right: 0.8rem;
      box-shadow: 0 0 8px rgba(10, 170, 255, 0.4);
      transition: background-color 0.2s ease;
    }
    button#downloadMd:hover,
    button#downloadJson:hover {
      background: #09e;
    }

    @media (max-width: 700px) {
      input[type=text], select, #newCategory {
        max-width: 100%;
      }
      #quillEditor {
        height: 220px;
      }
      pre#markdownContent,
      pre#jsonOutput {
        max-height: 240px;
      }
    }
  </style>
</head>
<body>

  <div id="header-placeholder"></div>

  <h1>Gadget Guide Article Editor</h1>

  <label for="articleLoader">Load Existing Article</label>
  <select id="articleLoader">
    <option value="">➕ New Article</option>
  </select>

  <label for="id">Article ID</label>
  <input type="text" id="id" placeholder="Unique article ID" autocomplete="off" />

  <label for="title">Title</label>
  <input type="text" id="title" placeholder="Article Title" autocomplete="off" />

  <label for="summary">Summary</label>
  <input type="text" id="summary" placeholder="Brief summary" autocomplete="off" />

  <label for="image">Image URL</label>
  <input type="text" id="image" placeholder="Image path or URL" autocomplete="off" />

  <label>Categories</label>
  <div id="categoryCheckboxes" aria-label="Category selection"></div>
  <input type="text" id="newCategory" placeholder="Add new category" autocomplete="off" />
  <button id="addCategoryBtn" type="button" aria-label="Add new category">Add Category</button>

  <label for="quillEditor">Content Editor (WYSIWYG)</label>
  <div id="quillEditor" role="textbox" aria-multiline="true" tabindex="0"></div>

  <label for="markdownContent">Markdown Output</label>
  <pre id="markdownContent" tabindex="0" aria-label="Markdown output">
    <button class="copy-corner-btn" id="copyMarkdownBtn" title="Copy Markdown to clipboard">Copy</button>
  </pre>

  <label for="jsonOutput">JSON Output (All Articles)</label>
  <pre id="jsonOutput" tabindex="0" aria-label="JSON output">
    <button class="copy-corner-btn" id="copyJsonBtn" title="Copy JSON to clipboard">Copy</button>
  </pre>

  <button id="downloadMd" type="button">Download Markdown (.md)</button>
  <button id="downloadJson" type="button">Download JSON (articles.json)</button>

  <script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/turndown/dist/turndown.js"></script>

  <script>
    // Load header.html
    fetch('header.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('header-placeholder').innerHTML = html;
      })
      .catch(() => {
        document.getElementById('header-placeholder').textContent = 'Failed to load header.';
      });

    let allArticles = [];

    const articleLoader = document.getElementById('articleLoader');
    const idInput = document.getElementById('id');
    const titleInput = document.getElementById('title');
    const summaryInput = document.getElementById('summary');
    const imageInput = document.getElementById('image');
    const categoryCheckboxes = document.getElementById('categoryCheckboxes');
    const newCategoryInput = document.getElementById('newCategory');
    const addCategoryBtn = document.getElementById('addCategoryBtn');
    const markdownContent = document.getElementById('markdownContent');
    const jsonOutput = document.getElementById('jsonOutput');
    const copyMarkdownBtn = document.getElementById('copyMarkdownBtn');
    const copyJsonBtn = document.getElementById('copyJsonBtn');
    const downloadMdBtn = document.getElementById('downloadMd');
    const downloadJsonBtn = document.getElementById('downloadJson');

    // Initialize Quill editor
    const quill = new Quill('#quillEditor', {
      theme: 'snow',
      modules: {
        toolbar: [
          [{ header: [1, 2, 3, false] }],
          ['bold', 'italic', 'underline', 'strike'],
          [{ list: 'ordered' }, { list: 'bullet' }],
          ['link', 'image', 'code-block'],
          ['clean']
        ]
      }
    });

    // Build JSON object for current article
    function buildArticleJson() {
      const selectedCategories = Array.from(categoryCheckboxes.querySelectorAll('input[type=checkbox]:checked'))
        .map(cb => cb.value);

      return {
        id: idInput.value.trim(),
        title: titleInput.value.trim(),
        summary: summaryInput.value.trim(),
        image: imageInput.value.trim(),
        categories: selectedCategories
      };
    }

    // Populate categories checkboxes from allArticles
    function populateCategories() {
      const cats = new Set();
      allArticles.forEach(a => {
        (a.categories || []).forEach(c => cats.add(c));
      });
      categoryCheckboxes.innerHTML = '';
      Array.from(cats).sort().forEach(cat => {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = cat;
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(cat));
        categoryCheckboxes.appendChild(label);
      });
    }

    // Populate the article loader dropdown
    function populateArticleLoader() {
      articleLoader.innerHTML = '<option value="">➕ New Article</option>';
      allArticles.forEach(article => {
        const opt = document.createElement('option');
        opt.value = article.id;
        opt.textContent = article.title;
        articleLoader.appendChild(opt);
      });
    }

    // Load markdown content from article markdown file
    async function loadArticleMarkdown(articleId) {
      try {
        const res = await fetch(`articles/${articleId}.md`);
        if (!res.ok) throw new Error('No markdown found');
        return await res.text();
      } catch {
        return '';
      }
    }

    // Load article into form and quill editor
    async function loadArticle(articleId) {
      if (!articleId) {
        clearForm();
        return;
      }
      const article = allArticles.find(a => a.id === articleId);
      if (!article) {
        alert('Article not found.');
        return;
      }

      idInput.value = article.id;
      titleInput.value = article.title;
      summaryInput.value = article.summary;
      imageInput.value = article.image || '';
      // Uncheck all categories first
      categoryCheckboxes.querySelectorAll('input[type=checkbox]').forEach(cb => cb.checked = false);
      (article.categories || []).forEach(cat => {
        const cb = categoryCheckboxes.querySelector(`input[value="${cat}"]`);
        if (cb) cb.checked = true;
      });

      const md = await loadArticleMarkdown(article.id);
      const html = marked.parse(md || '');
      quill.root.innerHTML = html;
      updateMarkdownOutput();
      updateJsonOutput();
    }

    // Clear all inputs and editor
    function clearForm() {
      idInput.value = '';
      titleInput.value = '';
      summaryInput.value = '';
      imageInput.value = '';
      categoryCheckboxes.querySelectorAll('input[type=checkbox]').forEach(cb => cb.checked = false);
      quill.root.innerHTML = '';
      updateMarkdownOutput();
      updateJsonOutput();
    }

    // Update markdown output area from Quill content
    function updateMarkdownOutput() {
      const html = quill.root.innerHTML;
      const turndownService = new TurndownService();
      const md = turndownService.turndown(html);
      markdownContent.textContent = md.trim();
    }

    // Update JSON output with current article merged
    function updateJsonOutput() {
      const currentArticle = buildArticleJson();
      if (!currentArticle.id) {
        jsonOutput.textContent = JSON.stringify(allArticles, null, 2);
        return;
      }
      const updated = allArticles.filter(a => a.id !== currentArticle.id);
      updated.push(currentArticle);
      jsonOutput.textContent = JSON.stringify(updated, null, 2);
    }

    // Copy helper (supports fallback)
    function copyText(text) {
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => alert('Copied to clipboard!'));
      } else {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.top = '-9999px';
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        try {
          document.execCommand('copy');
          alert('Copied to clipboard!');
        } catch {
          alert('Failed to copy');
        }
        document.body.removeChild(ta);
      }
    }

    // Event listeners

    // Load article when selection changes
    articleLoader.addEventListener('change', e => {
      loadArticle(e.target.value);
    });

    // Add new category
    addCategoryBtn.addEventListener('click', () => {
      const newCat = newCategoryInput.value.trim();
      if (!newCat) return alert('Please enter a category name.');
      const exists = Array.from(categoryCheckboxes.querySelectorAll('input'))
        .some(cb => cb.value.toLowerCase() === newCat.toLowerCase());
      if (exists) {
        alert('Category already exists.');
        return;
      }
      const label = document.createElement('label');
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.value = newCat;
      checkbox.checked = true;
      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(newCat));
      categoryCheckboxes.appendChild(label);
      newCategoryInput.value = '';
      updateJsonOutput();
    });

    // Update markdown & JSON on Quill text change
    quill.on('text-change', () => {
      updateMarkdownOutput();
      updateJsonOutput();
    });

    // Update JSON on form changes
    [idInput, titleInput, summaryInput, imageInput, categoryCheckboxes].forEach(el => {
      el.addEventListener('input', updateJsonOutput);
      el.addEventListener('change', updateJsonOutput);
    });

    // Copy buttons
    copyMarkdownBtn.addEventListener('click', () => {
      copyText(markdownContent.textContent);
    });
    copyJsonBtn.addEventListener('click', () => {
      copyText(jsonOutput.textContent);
    });

    // Download markdown
    downloadMdBtn.addEventListener('click', () => {
      const filename = (idInput.value.trim() || 'article') + '.md';
      const blob = new Blob([markdownContent.textContent], {type: 'text/markdown'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    });

    // Download JSON
    downloadJsonBtn.addEventListener('click', () => {
      const blob = new Blob([jsonOutput.textContent], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'articles.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    // Load articles.json on start
    fetch('articles.json')
      .then(r => r.json())
      .then(data => {
        allArticles = data;
        populateArticleLoader();
        populateCategories();
      })
      .catch(() => {
        alert('Failed to load articles.json');
      });
  </script>
</body>
</html>